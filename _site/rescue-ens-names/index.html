<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Klise Theme" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Klise Theme" /> <title> Using Flashbots to rescue ENS names from compromised wallets - Klise Theme </title> <link rel="alternate" href="https://klise.now.sh/rescue-ens-names/" hreflang="en-US" /> <link rel="canonical" href="https://klise.now.sh/rescue-ens-names/" /> <meta name="description" content="He&#39;s writing in Bahasa about web technology and experience as a journal for documentation things that he learned, meet him @github." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Using Flashbots to rescue ENS names from compromised wallets | lcfr" /> <meta property="og:title" content="Using Flashbots to rescue ENS names from compromised wallets | lcfr" /> <meta property="og:type" content="website" /> <meta property="og:url" content="https://klise.now.sh/rescue-ens-names/" /> <meta property="og:description" content="He&#39;s writing in Bahasa about web technology and experience as a journal for documentation things that he learned, meet him @github." /> <meta property="og:image" content="https://klise.now.sh/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Using Flashbots to rescue ENS names from compromised wallets | lcfr_eth" /> <meta name="twitter:url" content="https://klise.now.sh/rescue-ens-names/" /> <meta name="twitter:site" content="@lcfr_eth" /> <meta name="twitter:creator" content="@lcfr_eth" /> <meta name="twitter:description" content="He&#39;s writing in Bahasa about web technology and experience as a journal for documentation things that he learned, meet him @github." /> <meta name="twitter:image" content="https://klise.now.sh/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="https://klise.now.sh/feed.xml" title="Klise Theme" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="/about/">about</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <h1 class="header-title" itemprop="headline">Using Flashbots to rescue ENS names from compromised wallets</h1> <div class="post-meta"> <time datetime="2022-05-19T07:28:22+07:00" itemprop="datePublished"> May 19, 2022 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">lcfr</span> </span> <time hidden datetime="" itemprop="dateModified"> May 19, 2022 </time> <span hidden itemprop="publisher" itemtype="Person">lcfr</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><h1 id="rescuing-ens-names-from-compromised-wallets-overview">Rescuing ENS names from compromised wallets (overview).</h1> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <h1 id="rescuing-ens-names-from-compromised-wallets-overview"> <a href="#rescuing-ens-names-from-compromised-wallets-overview" class="anchor-head"></a> Rescuing ENS names from compromised wallets (overview). </h1> <p>Inspired by nick.eth’s twitter post <a href="https://twitter.com/nicksdjohnson/status/1527065045678452736">here</a> <img src="/assets/img/nick.png" alt="image" /></p> <p>Often times when a wallet is compromised the attacker will leave some assets as a trap for the owner.</p> <p>The trap works as follows: 1) The attacker leaves some tokens in the compromised wallet but drains all the ether. 2) This means the owner can not transfer the tokens in the wallet until they send it more ether to cover the gas fee. 3) wait for the legitimate owner to try and save their precious tokens by sending eth to cover the gas fees of transferTo and and rob them again.</p> <p>A “sweeper” loads a private key and attempts to send the full balance in a loop without much worry about processing power. Enabling it to run indefinately for free or until cancelled/closed.</p> <p>The problem being how does the hacked user send ether to the compromised account to fund the transaction of saving our tokens?</p> <h1 id="enter-flashbots-bundles--sponsored-transactions"> <a href="#enter-flashbots-bundles--sponsored-transactions" class="anchor-head"></a> Enter Flashbots bundles &amp; sponsored transactions: </h1> <p><a href="https://github.com/flashbots/searcher-sponsored-tx">https://github.com/flashbots/searcher-sponsored-tx</a></p> <p>Sponsored transactions allow for one address to pay for the fees of another address’s transaction by paying the miner directly using the solidity global block.coinbase. block.coinbase is a payable alias to the current block miners coinbase/payment address.</p> <p><a href="https://docs.soliditylang.org/en/latest/units-and-global-variables.html">https://docs.soliditylang.org/en/latest/units-and-global-variables.html</a></p> <p>A simple contract below demonstrates fowarding payments to a miner:</p><pre><code class="language-commandline">pragma solidity ^0.8.7;
contract MinerPayment {
    function payMiner() external payable {
        block.coinbase.transfer(msg.value);
    }
}
</code></pre><p>The flashbots team has deployed a simple contract which can be used for this here: <a href="https://etherscan.io/address/0xc4595e3966e0ce6e3c46854647611940a09448d3#code">CheckAndSend Contract</a></p> <p>Next we need to understand a few EIP1559 specifics such as MaxFeePerGas, MaxPriorityFeePerGas and the blocks baseFee and how they are used to calculate the gas fee/cost of a transaction. This won’t be covered.</p> <p>For an overview of EIP1559 Gas description you can read <a href="https://docs.alchemy.com/alchemy/guides/eip-1559/maxpriorityfeepergas-vs-maxfeepergas">here</a></p> <p>A note on transactions - an address must /always/ have the gas in its own balance to cover the block baseFee amount.</p> <p>A sponsored transaction can only cover the MaxPriorityFeePerGas for another transaction and not the MaxFeePerGas. <a href="https://docs.flashbots.net/flashbots-auction/searchers/advanced/eip1559">More info</a></p> <p>How do we send the address ether to cover the gas fee for MaxFeePerGas without the attackers robbing it?</p> <h1 id="flashbots-bundles"> <a href="#flashbots-bundles" class="anchor-head"></a> Flashbots bundles </h1> <p>Flashbots works by sending bundles of transactions in a sort of private pool where people bid/pay miners directly.</p> <p>A bundle is an array of transactions which will be executed consecutively in the same block/transaction. If any transaction in the bundle shall fail the whole bundle will revert.</p> <p>Users do not pay for failed transactions while using flashbots for submitting bundles.</p> <p><a href="https://docs.flashbots.net/flashbots-auction/overview">More info on FlashBots</a></p> <p>The real magic that allows us to save tokens is the bundle functionality + sponsored transactions to be able to execute the bundle from another wallet besides the compromised wallet. Not the fact that the transactions are “private”.</p> <h1 id="plan-of-counter-attack"> <a href="#plan-of-counter-attack" class="anchor-head"></a> Plan of counter attack </h1> <p>This means, we can create a bundle of 3 transactions to accomplish this which will all be executed as if they were a single transaction in a single block.</p> <p>Step 1 - send eth from another wallet to the compromised wallet to cover block baseFee.</p> <p>Step 2 - transferTo the token from the compromised wallet to the rescuer wallet.</p> <p>Step 3 - execute &amp; pay for the transaction using sponsored transaction from the rescuer wallet via block.coinbase</p> <h1 id="usage-example"> <a href="#usage-example" class="anchor-head"></a> usage example </h1><pre><code class="language-commandline">ENSRescue.py --name hero --hacked-key AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA --rescuer-key xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
[+] testnet enabled, connected to goerli infura node.
[+] rescuing names from: 0x59a02AA24367b293902002f1Df1F5D55e76B5b4C.
[+] sending rescued names to: 0x328eBc7bb2ca4Bf4216863042a960E3C64Ed4c10.
[+] Rescuing hero!
[+] token_id of hero.eth : 111124751542167998813960028570131154730449316884244675085439636823004772343202
[+] Bundle broad casted at block 6914883
...
[+] Bundle broad casted at block 6914888

[AttributeDict({'blockHash': HexBytes('0x342e7a0583e970df5c26bd5510331c681c01367921b182fcd1748674ecbf95e2'), 'blockNumber': 6914889, 'contractAddress': None, 'cumulativeGasUsed': 21000, 'effectiveGasPrice': 8, 'from': '0x328eBc7bb2ca4Bf4216863042a960E3C64Ed4c10', 'gasUsed': 21000, 'logs': [], 'logsBloom': HexBytes('0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'), 'status': 1, 'to': '0x59a02AA24367b293902002f1Df1F5D55e76B5b4C', 'transactionHash': HexBytes('0x9845e7f18876f676b787af1a9bad1f2c8d587ef1d05691eeefedae71b4764ec8'), 'transactionIndex': 0, 'type': '0x2'}), AttributeDict({'blockHash': HexBytes('0x342e7a0583e970df5c26bd5510331c681c01367921b182fcd1748674ecbf95e2'), 'blockNumber': 6914889, 'contractAddress': None, 'cumulativeGasUsed': 62215, 'effectiveGasPrice': 8, 'from': '0x59a02AA24367b293902002f1Df1F5D55e76B5b4C', 'gasUsed': 41215, 'logs': [AttributeDict({'address': '0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85', 'blockHash': HexBytes('0x342e7a0583e970df5c26bd5510331c681c01367921b182fcd1748674ecbf95e2'), 'blockNumber': 6914889, 'data': '0x', 'logIndex': 0, 'removed': False, 'topics': [HexBytes('0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef'), HexBytes('0x00000000000000000000000059a02aa24367b293902002f1df1f5d55e76b5b4c'), HexBytes('0x000000000000000000000000328ebc7bb2ca4bf4216863042a960e3c64ed4c10'), HexBytes('0xf5ae61672361c474f5ea3e994da5ef9670fc4455792bd5cc81189dd6b2dc9da2')], 'transactionHash': HexBytes('0xb82841e22c1e6c7e1c443fc9d938b9e42b6318d7b505e47efc581cda4528d853'), 'transactionIndex': 1})], 'logsBloom': HexBytes('0x00000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010100000000000000000000000000000000004000040000000000000000000000000000000000000000000000000004000000004000000000000000000000000000000000000400002000080000000000000000000000000000000000000080000820000000000000000000000000000000000000000000000000000000000000000002000'), 'status': 1, 'to': '0x57f1887a8BF19b14fC0dF6Fd9B2acc9Af147eA85', 'transactionHash': HexBytes('0xb82841e22c1e6c7e1c443fc9d938b9e42b6318d7b505e47efc581cda4528d853'), 'transactionIndex': 1, 'type': '0x2'}), AttributeDict({'blockHash': HexBytes('0x342e7a0583e970df5c26bd5510331c681c01367921b182fcd1748674ecbf95e2'), 'blockNumber': 6914889, 'contractAddress': None, 'cumulativeGasUsed': 93196, 'effectiveGasPrice': 8, 'from': '0x328eBc7bb2ca4Bf4216863042a960E3C64Ed4c10', 'gasUsed': 30981, 'logs': [], 'logsBloom': HexBytes('0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'), 'status': 1, 'to': '0xFee1708400f01f2Bb8848Ef397C1a2F4C25c910B', 'transactionHash': HexBytes('0x5191f545478467cde77fad24a937a18e7778775402f5459b3cd0f2e6f6645136'), 'transactionIndex': 2, 'type': '0x2'})]

[+] Transaction confirmed at block 6914889 [flashbots]
</code></pre><h1 id="code"> <a href="#code" class="anchor-head"></a> code </h1> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#
# ENS Flashbots Rescue script (sponsored transaction)
# https://twitter.com/nicksdjohnson/status/1527065045678452736
#
# can be used to rescue a single name or provide a list of up to 29 names
# to rescue in a single transaction.
</span>
<span class="c1"># lcfr.eth
</span>
<span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span><span class="p">,</span> <span class="n">HTTPProvider</span>
<span class="kn">from</span> <span class="nn">eth_account</span> <span class="kn">import</span> <span class="n">Account</span>
<span class="kn">from</span> <span class="nn">eth_account.signers.local</span> <span class="kn">import</span> <span class="n">LocalAccount</span>
<span class="kn">from</span> <span class="nn">web3.middleware</span> <span class="kn">import</span> <span class="n">construct_sign_and_send_raw_middleware</span>
<span class="kn">from</span> <span class="nn">web3.middleware</span> <span class="kn">import</span> <span class="n">geth_poa_middleware</span>
<span class="kn">from</span> <span class="nn">flashbots</span> <span class="kn">import</span> <span class="n">flashbot</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

<span class="kn">import</span> <span class="nn">argparse</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">math</span>

<span class="k">class</span> <span class="nc">ENSRescue</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">test_net</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">test_net</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">target_name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">basefee_premium</span> <span class="o">=</span> <span class="mf">1.12</span> <span class="c1"># 12% baseFee adjustment
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">base_tip</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">base_tip</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">last_sent_block</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">rescuer_key</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">rescuer_key</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">hacked_key</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">hacked_key</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">names_file</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">names_file</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">"NODE"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">rescuer_account</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">rescuer_account</span>
        <span class="c1"># Account with funds for the rescue operation
</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ETH_ACCOUNT</span><span class="p">:</span> <span class="n">LocalAccount</span> <span class="o">=</span> <span class="n">Account</span><span class="p">.</span><span class="n">from_key</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">rescuer_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">HACK_ACCOUNT</span><span class="p">:</span> <span class="n">LocalAccount</span> <span class="o">=</span> <span class="n">Account</span><span class="p">.</span><span class="n">from_key</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">hacked_key</span><span class="p">)</span>


        <span class="bp">self</span><span class="p">.</span><span class="n">ENS_BASE_REGISTRAR</span> <span class="o">=</span> <span class="s">"0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">test_net</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"FLASHBOTS_HTTP_PROVIDER_URI"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"https://relay-goerli.flashbots.net"</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">provider</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"https://goerli.infura.io/v3/yourkeyherelol"</span> <span class="c1">#goerli
</span>            <span class="k">print</span><span class="p">(</span><span class="s">"[+] testnet enabled, connected to goerli infura node."</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">chainID</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">provider</span><span class="p">:</span>
            <span class="nb">exit</span><span class="p">(</span><span class="s">"[-] export provider URL in NODE env variable. Local or Infura or enable testnet mode."</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">provider</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">default_account</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">ETH_ACCOUNT</span><span class="p">.</span><span class="n">address</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">test_net</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">middleware_onion</span><span class="p">.</span><span class="n">inject</span><span class="p">(</span><span class="n">geth_poa_middleware</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">middleware_onion</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">construct_sign_and_send_raw_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ETH_ACCOUNT</span><span class="p">))</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">br_abi_json</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'./abi/'</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">ENS_BASE_REGISTRAR</span> <span class="o">+</span> <span class="s">'.json'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">ENS_REGISTRAR</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">contract</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">toChecksumAddress</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ENS_BASE_REGISTRAR</span><span class="p">),</span>
            <span class="n">abi</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">br_abi_json</span>
        <span class="p">)</span>

        <span class="n">flashbot</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">ETH_ACCOUNT</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">flashbots</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">flashbots</span>

    <span class="k">def</span> <span class="nf">derive_token_from_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">Web3</span><span class="p">.</span><span class="n">keccak</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">name</span><span class="p">).</span><span class="nb">hex</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">transfer_from_call_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_acct</span><span class="p">,</span> <span class="n">to_acct</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="n">call_data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">ENS_REGISTRAR</span><span class="p">.</span><span class="n">encodeABI</span><span class="p">(</span><span class="n">fn_name</span><span class="o">=</span><span class="s">"transferFrom"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">from_acct</span><span class="p">,</span> <span class="n">to_acct</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">call_data</span>

    <span class="k">def</span> <span class="nf">get_miner_calldata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="n">miner_abi</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'./abi/0xfee1708400f01f2bb8848ef397c1a2f4c25c910b.json'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
        <span class="n">miner_contract</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">contract</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">toChecksumAddress</span><span class="p">(</span><span class="s">"0xfee1708400f01f2bb8848ef397c1a2f4c25c910b"</span><span class="p">),</span>
            <span class="n">abi</span><span class="o">=</span><span class="n">miner_abi</span>
        <span class="p">)</span>
        <span class="n">call_data_miner</span> <span class="o">=</span> <span class="n">miner_contract</span><span class="p">.</span><span class="n">encodeABI</span><span class="p">(</span><span class="n">fn_name</span><span class="o">=</span><span class="s">"payMiner"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">toWei</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="s">"gwei"</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">call_data_miner</span>

    <span class="k">def</span> <span class="nf">blank_tx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"signer"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">HACK_ACCOUNT</span><span class="p">,</span>
             <span class="s">"transaction"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">'chainId'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">chainID</span><span class="p">,</span>
                <span class="s">'nonce'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">"maxFeePerGas"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">"maxPriorityFeePerGas"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">'gas'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  
                <span class="s">'to'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">toChecksumAddress</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ENS_BASE_REGISTRAR</span><span class="p">),</span> <span class="c1"># change to ENS address
</span>                <span class="s">"data"</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">tx</span>

    <span class="k">def</span> <span class="nf">blank_miner_tx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">miner_pay_tx</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"signer"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">ETH_ACCOUNT</span><span class="p">,</span>
            <span class="s">"transaction"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">'chainId'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">chainID</span><span class="p">,</span>
                <span class="s">'nonce'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">"maxFeePerGas"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">"maxPriorityFeePerGas"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">'to'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">toChecksumAddress</span><span class="p">(</span><span class="s">'0xfee1708400f01f2bb8848ef397c1a2f4c25c910b'</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">miner_pay_tx</span>


    <span class="k">def</span> <span class="nf">build_bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="n">bundle_txs</span>      <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rescue_tx_cnt</span>   <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hack_tx_cnt</span>     <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_gas_cost</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="n">estimate</span>        <span class="o">=</span> <span class="mi">0</span>

        <span class="n">nonce_hack</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">getTransactionCount</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">HACK_ACCOUNT</span><span class="p">.</span><span class="n">address</span><span class="p">)</span>
        <span class="n">nonce_rescue</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">getTransactionCount</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ETH_ACCOUNT</span><span class="p">.</span><span class="n">address</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">28</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">". Bundle can only hold 29 name transactions and found &gt; 29 Names"</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># loop names and do estimateGas() on transferFrom method to get the total gas cost we need to send the account.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">default_account</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">HACK_ACCOUNT</span><span class="p">.</span><span class="n">address</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            <span class="n">estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">ENS_REGISTRAR</span><span class="p">.</span><span class="n">functions</span><span class="p">.</span><span class="n">transferFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">HACK_ACCOUNT</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">ETH_ACCOUNT</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">name</span><span class="p">).</span><span class="n">estimateGas</span><span class="p">()</span>
            <span class="n">base_fee</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">fee_history</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">'latest'</span><span class="p">)</span>
            <span class="n">gas_total</span> <span class="o">=</span> <span class="n">estimate</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">floor</span><span class="p">(</span><span class="n">base_fee</span><span class="p">[</span><span class="s">"baseFeePerGas"</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">basefee_premium</span><span class="p">)</span>
            <span class="n">total_gas_cost</span> <span class="o">+=</span> <span class="n">gas_total</span>

        <span class="n">base_fee</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">fee_history</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">'latest'</span><span class="p">)</span>
        <span class="n">fund_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">blank_miner_tx</span><span class="p">()</span>

        <span class="n">fund_tx</span><span class="p">[</span><span class="s">"signer"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">ETH_ACCOUNT</span>
        <span class="n">fund_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"nonce"</span><span class="p">]</span> <span class="o">=</span> <span class="n">nonce_rescue</span>
        <span class="n">fund_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"to"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">toChecksumAddress</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">HACK_ACCOUNT</span><span class="p">.</span><span class="n">address</span><span class="p">)</span>
        <span class="n">fund_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"from"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">toChecksumAddress</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ETH_ACCOUNT</span><span class="p">.</span><span class="n">address</span><span class="p">)</span>
        <span class="n">fund_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"maxFeePerGas"</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">floor</span><span class="p">(</span><span class="n">base_fee</span><span class="p">[</span><span class="s">"baseFeePerGas"</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">basefee_premium</span><span class="p">)</span>
        <span class="n">fund_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"gas"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">21000</span>
        <span class="n">fund_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"value"</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_gas_cost</span>
        <span class="n">bundle_txs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">fund_tx</span><span class="p">)</span>
        <span class="n">rescue_tx_cnt</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            <span class="n">base_fee</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">fee_history</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">'latest'</span><span class="p">)</span>
            <span class="n">rescue_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">blank_tx</span><span class="p">()</span>
            <span class="n">rescue_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"nonce"</span><span class="p">]</span> <span class="o">=</span> <span class="n">nonce_hack</span> <span class="o">+</span> <span class="n">hack_tx_cnt</span>
            <span class="n">rescue_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"gas"</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimate</span>
            <span class="n">rescue_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"maxFeePerGas"</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">floor</span><span class="p">(</span><span class="n">base_fee</span><span class="p">[</span><span class="s">"baseFeePerGas"</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">basefee_premium</span><span class="p">)</span>
            <span class="n">rescue_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"data"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_from_call_data</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">HACK_ACCOUNT</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">rescuer_account</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">bundle_txs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">rescue_tx</span><span class="p">)</span>
            <span class="n">hack_tx_cnt</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">miner_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">blank_miner_tx</span><span class="p">()</span>
        <span class="n">base_fee</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">fee_history</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">'latest'</span><span class="p">)</span>
        <span class="n">miner_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"maxFeePerGas"</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">floor</span><span class="p">(</span><span class="n">base_fee</span><span class="p">[</span><span class="s">"baseFeePerGas"</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">basefee_premium</span><span class="p">)</span>
        <span class="n">miner_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"nonce"</span><span class="p">]</span> <span class="o">=</span> <span class="n">nonce_rescue</span> <span class="o">+</span> <span class="n">rescue_tx_cnt</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">base_tip</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>  <span class="c1"># self.base_tip 1.5 Gwei * Names = 1.5Gwei per name as tip.
</span>        <span class="n">miner_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"data"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_miner_calldata</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">miner_tx</span><span class="p">[</span><span class="s">"transaction"</span><span class="p">][</span><span class="s">"value"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">toWei</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"gwei"</span><span class="p">)</span>

        <span class="n">bundle_txs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">miner_tx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bundle_txs</span>

    <span class="k">def</span> <span class="nf">simulate_tx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">flashbots</span><span class="p">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">block_tag</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">block_number</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">"error"</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s">"results"</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">"results"</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">exit</span><span class="p">(</span><span class="sa">f</span><span class="s">"[-] </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s">'results'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'error'</span><span class="p">]</span><span class="si">}</span><span class="s"> - check tx and try again."</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">send_and_wait_flashbots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">simulate_tx</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
        <span class="n">block_number</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">blockNumber</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">last_sent_block</span> <span class="o">==</span> <span class="n">block_number</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">flashbots</span><span class="p">.</span><span class="n">send_bundle</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">target_block_number</span><span class="o">=</span><span class="n">block_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">last_sent_block</span> <span class="o">=</span> <span class="n">block_number</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] Bundle broad casted at block </span><span class="si">{</span><span class="n">block_number</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">receipts</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">receipts</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">receipts</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] Transaction confirmed at block </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">w3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">block_number</span><span class="si">}</span><span class="s"> [flashbots]"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">rescue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="n">confirmed</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">confirmed</span><span class="p">:</span>
            <span class="n">rescue_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">build_bundle</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="n">confirmed</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">send_and_wait_flashbots</span><span class="p">(</span><span class="n">rescue_bundle</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] rescuing names from: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">HACK_ACCOUNT</span><span class="p">.</span><span class="n">address</span><span class="si">}</span><span class="s">."</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">rescuer_account</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">rescuer_account</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">ETH_ACCOUNT</span><span class="p">.</span><span class="n">address</span>

        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] sending rescued names to: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">rescuer_account</span><span class="si">}</span><span class="s">."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">names_file</span><span class="p">:</span>
            <span class="n">name_list</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"./"</span><span class="o">+</span><span class="bp">self</span><span class="p">.</span><span class="n">names_file</span><span class="p">,</span> <span class="s">'r'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">name_list</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">""</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">names</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">derive_token_from_name</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">target</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] Rescuing </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">target</span><span class="si">}</span><span class="s">!"</span><span class="p">)</span>
            <span class="n">token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">derive_token_from_name</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] token_id of </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">target</span><span class="si">}</span><span class="s">.eth : </span><span class="si">{</span><span class="n">token_id</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="n">names</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#print("doing rescue lol")
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">rescue</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">exit</span><span class="p">(</span><span class="s">"[-] No names or file-path of names provided to rescue!"</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"ENSRescue - lcfr.eth (6/22)</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--name"</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"target_name"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"Target ENS name to purchase. or use --names-file for file/list of names."</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--hacked-key"</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"hacked_key"</span><span class="p">,</span>  <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"Private Key of the compromised wallet."</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--rescuer-key"</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"rescuer_key"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"Private key of uncompromised wallet with funds to pay for the rescue."</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--rescue-account"</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"rescuer_account"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"Address where to send rescued names. Does not need to be the address of --rescuer-key."</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--names-file"</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"names_file"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"File path name of list of names to rescue."</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--basetip"</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"base_tip"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"Base tip in GWEI - default is 1.5gwei, you can try to set this lower to save on total cost"</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--testnet"</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"test_net"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">'store_true'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">"Enable Testnet"</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ENSRescue</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">x</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></div> </div> </article> </main> <footer class="footer"> <a class="footer_item" href="/thanks">ack.</a> <a class="footer_item" href="javascript::void(0)">resume</a> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2022</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
